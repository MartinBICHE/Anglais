<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu de Jeu - Modes</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/menu.css') }}">
</head>
<body>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    <button class="menu-button" id="menuBtn" onclick="toggleSidebar()">☰ Menu</button>
    <div class="sidebar" id="sidebar">
        <button class="close-button" onclick="toggleSidebar()">❮</button>
        <img src="{{ url_for('static', filename='images/Logo.png') }}" alt="Logo">
        <hr>
        {% if isauth %}
            <a href="/profile/">Profile</a>
            <a href="/logout">Log out</a>
        {% else %}
            <a href="javascript:void(0);" onclick="toggleForm('register')">Register</a>
            <a href="javascript:void(0);" onclick="toggleForm('login')">Login</a>
        {% endif %}
        
        <div id="registerForm" class="form-container">
            <form action="/register/" method="POST">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <input type="submit" value="Register" class="input3">
            </form>
        </div>

        <div id="loginForm" class="form-container">
            <form action="/login/" method="POST">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <input type="submit" value="Login" class="input3">
            </form>
        </div>

    </div>

    <div class="content">
        <div class="title-roulette">
            <div class="title" id="titleLeft"></div>
            <div class="title" id="titleCenter"></div>
            <div class="title" id="titleRight"></div>
        </div>
    
        <div class="carousel-container">
            <div class="carousel">
                <div class="mode" style="background-image: url('{{ url_for('static', filename='images/flashcards.png') }}');" data-mode="flashcards">Flashcards</div>
                <div class="mode" style="background-image: url('{{ url_for('static', filename='images/crossword.png') }}');" data-mode="crossword">Crossword</div>
                <div class="mode" style="background-image: url('{{ url_for('static', filename='images/wordSearch.png') }}');" data-mode="word_search_puzzle">Word search puzzle</div>
                <div class="mode" style="background-image: url('{{ url_for('static', filename='images/memory.png') }}');background-position: center -55px;" data-mode="memory">Memory</div>
                <div class="mode" style="background-image: url('{{ url_for('static', filename='images/fill_the_blanks.png') }}');" data-mode="fill_the_blanks">Fill the blanks</div>
            </div>
    
            <div class="controls">
                <button class="arrow left">&#10094;</button>
                <button class="arrow right">&#10095;</button>
            </div>
        </div>
    
        <button class="play-button" id="playButton">Play</button>
    </div>

    <script>
        const isAuthenticated = {{ 'true' if isauth else 'false' }};
        const carousel = document.querySelector('.carousel');
        const originalModes = Array.from(document.querySelectorAll('.mode'));
        const titleLeft = document.getElementById('titleLeft');
        const titleCenter = document.getElementById('titleCenter');
        const titleRight = document.getElementById('titleRight');
    
        const firstClone = originalModes[0].cloneNode(true);
        const lastClone = originalModes[originalModes.length - 1].cloneNode(true);
        firstClone.id = 'first-clone';
        lastClone.id = 'last-clone';
        carousel.insertBefore(lastClone, carousel.firstChild);
        carousel.appendChild(firstClone);
    
        let currentIndex = 1;
        let selectedMode = originalModes[0].getAttribute('data-mode');
        let autoScrollInterval;
        let inactivityTimeout;
    
        function updateCarousel() {
            const children = carousel.children;
            carousel.style.transition = 'transform 0.5s ease-in-out';
            carousel.style.transform = `translateX(${-currentIndex * 100}%)`;
    
            selectedMode = children[currentIndex].getAttribute('data-mode');
    
            const leftIndex = (currentIndex === 0) ? children.length - 2 : currentIndex - 1;
            const rightIndex = (currentIndex === children.length - 1) ? 1 : currentIndex + 1;
    
            titleLeft.textContent = children[leftIndex].textContent;
            titleCenter.textContent = children[currentIndex].textContent;
            titleRight.textContent = children[rightIndex].textContent;
    
            titleLeft.style.filter = 'blur(4px)';
            titleCenter.style.filter = 'none';
            titleRight.style.filter = 'blur(4px)';
        }
    
        carousel.addEventListener('transitionend', () => {
            const children = carousel.children;
            if (children[currentIndex].id === 'first-clone') {
                carousel.style.transition = 'none';
                currentIndex = 1;
                carousel.style.transform = `translateX(${-currentIndex * 100}%)`;
            } else if (children[currentIndex].id === 'last-clone') {
                carousel.style.transition = 'none';
                currentIndex = children.length - 2;
                carousel.style.transform = `translateX(${-currentIndex * 100}%)`;
            }
        });
    
        function nextMode() {
            if (currentIndex >= carousel.children.length - 1) return;
            currentIndex++;
            updateCarousel();
        }
    
        function prevMode() {
            if (currentIndex <= 0) return;
            currentIndex--;
            updateCarousel();
        }
    
        function resetAutoScroll() {
            clearInterval(autoScrollInterval);
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => {
                autoScrollInterval = setInterval(nextMode, 3000);
            }, 20000);
        }
    
        document.querySelector('.left').addEventListener('click', () => {
            prevMode();
            resetAutoScroll();
        });
    
        document.querySelector('.right').addEventListener('click', () => {
            nextMode();
            resetAutoScroll();
        });
    
        Array.from(carousel.children).forEach((mode, index) => {
            mode.addEventListener('click', () => {
                currentIndex = index;
                updateCarousel();
                resetAutoScroll();
            });
        });
    
        document.getElementById('playButton').addEventListener('click', () => {
            if (!isAuthenticated) {
                toggleSidebar();
                const loginLink = Array.from(document.querySelectorAll('.sidebar a'))
                    .find(a => a.textContent.trim() === "Login");
                if (loginLink) {
                    loginLink.classList.add('blink');
                    setTimeout(() => loginLink.classList.remove('blink'), 3000);
                }
                return;
            }
            sessionStorage.setItem("selectedMode", selectedMode);
            window.location.href = "/theme";
        });
    
        function toggleSidebar() {
            let sidebar = document.getElementById('sidebar');
            let menuBtn = document.getElementById('menuBtn');
            let overlay = document.getElementById('overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            menuBtn.style.display = sidebar.classList.contains('open') ? 'none' : 'block';
        }
    
        function toggleForm(formType) {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'none';
            if (formType === 'register') {
                document.getElementById('registerForm').style.display = 'block';
            } else if (formType === 'login') {
                document.getElementById('loginForm').style.display = 'block';
            }
        }
    
        {% if badCredentials %}
            alert("Incorrect username or password!");
            toggleSidebar();
            toggleForm('login');
        {% endif %}
    
        {% if usernameExists %}
            alert("This username is already taken. Please choose another one.");
            toggleSidebar();
            toggleForm('register');
        {% endif %}
    
        carousel.style.transform = `translateX(-${currentIndex * 100}%)`;
        updateCarousel();
        resetAutoScroll();
    </script>    
        
</body>
</html>
